<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelightNovel - Webnovel Reader & Publisher (Local Only)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Configuration for Dark Mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Using a pitch black background for the body
                        'body-dark': '#000000',
                        'primary-dark': '#1e293b',   // Slate-800
                        'secondary-dark': '#334155', // Slate-700
                        'text-light': '#f8fafc',     // Slate-50
                        'text-dark': '#0f172a',      // Slate-900
                        'accent': '#6366f1',         // Indigo-500
                        'highlight-word': '#fcd34d', // Amber-300 for tracing
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pitch Black Background */
            color: #f8fafc;
            min-height: 100vh;
        }

        /* Custom scrollbar for novel content */
        #novel-display-content::-webkit-scrollbar,
        #novel-content-textarea::-webkit-scrollbar {
            width: 8px;
            background-color: #1e293b;
            border-radius: 4px;
        }

        #novel-display-content::-webkit-scrollbar-thumb,
        #novel-content-textarea::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 4px;
        }

        .novel-content-text {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Style for the tracing cursor (I-beam moves along the text) */
        .highlight-word {
            background-color: rgba(252, 211, 77, 0.3); /* Semi-transparent highlight */
            color: #fcd34d;
            border-radius: 2px;
            padding: 0 1px;
            transition: background-color 0.1s;
        }
        
        /* Placeholder for cover image if none is provided */
        .novel-cover-placeholder {
            background-color: #0f172a; /* Slate-900 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569; /* Slate-600 */
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-body-dark text-text-light p-4 md:p-8">

    <div id="mobile-disclaimer" class="fixed bottom-0 left-0 right-0 p-3 bg-yellow-600 text-black font-semibold text-center z-50 md:hidden">
        ⚠️ **Tip for Mobile Users:** For the best experience, please enable **Desktop Mode** in your browser settings.
    </div>
    <header class="mb-8 border-b border-indigo-500/50 pb-4">
        <h1 class="text-4xl font-extrabold text-white text-center">
            DelightNovel <span class="text-accent text-lg font-light">Free Publishing & Reader (Local Storage Only)</span>
        </h1>
        <p class="text-center text-sm text-red-400 mt-2 font-medium">
            ⚠️ **IMPORTANT:** Novels are saved ONLY in this browser. Use your **Secret Edit Key** to edit from other devices.
        </p>
    </header>

    <main class="max-w-7xl mx-auto">
        
        <div class="flex flex-col md:flex-row md:justify-between items-center mb-6 space-y-4 md:space-y-0">
            <h2 id="novel-list-title" class="text-2xl font-semibold text-text-light w-full md:w-auto text-center md:text-left"></h2>
            
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-3 w-full md:w-auto">
                <input type="text" id="novel-search-input" oninput="filterAndRenderNovels(this.value)"
                    placeholder="Search titles, authors, or tags..."
                    class="w-full sm:w-64 px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                    
                <button onclick="document.getElementById('add-novel-modal').classList.remove('hidden')"
                    class="w-full sm:w-auto bg-accent text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-600 transition duration-200">
                    + Publish New Novel
                </button>
            </div>
        </div>

        <div id="novel-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>

        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-primary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border border-accent/50 transform transition-all duration-300 scale-100">
                <h3 id="message-box-title" class="text-xl font-bold text-accent mb-3"></h3>
                <p id="message-box-content" class="text-text-light mb-5"></p>
                <div class="flex justify-end space-x-3">
                    <button id="message-box-cancel" onclick="closeMessageBox()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition hidden">Cancel</button>
                    <button id="message-box-confirm" onclick="confirmMessageBox()" class="px-4 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-indigo-600 transition">OK</button>
                </div>
            </div>
        </div>

    </main>

    <div id="add-novel-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div class="bg-primary-dark p-6 md:p-8 rounded-xl w-full max-w-lg shadow-2xl transform transition-all duration-300">
            <h2 class="text-2xl font-bold text-text-light mb-6 border-b border-slate-700 pb-2">Publish New Webnovel</h2>
            <form id="add-novel-form" onsubmit="handleNovelSubmit(event)">
                <div class="mb-4">
                    <label for="novel-title" class="block text-sm font-medium text-text-light mb-1">Title</label>
                    <input type="text" id="novel-title" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-4">
                    <label for="novel-author" class="block text-sm font-medium text-text-light mb-1">Author Name (Your Publisher ID)</label>
                    <input type="text" id="novel-author" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition"
                        placeholder="e.g., TheSilentPen">
                </div>
                <div class="mb-4">
                    <label for="novel-cover-image" class="block text-sm font-medium text-text-light mb-1">Cover Image URL (Optional)</label>
                    <input type="text" id="novel-cover-image" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition"
                        placeholder="Paste a link to your novel's cover image (e.g., from Imgur)">
                </div>
                <div class="mb-4">
                    <label for="novel-tags" class="block text-sm font-medium text-text-light mb-1">Tags (e.g., Fantasy, Sci-Fi, Action - comma separated)</label>
                    <input type="text" id="novel-tags" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                
                <div class="mb-6 bg-red-900/30 p-3 rounded-lg border border-red-600">
                    <p class="text-sm font-bold text-red-300 mb-1">⚠️ IMPORTANT SECURITY DISCLAIMER</p>
                    <p class="text-xs text-red-200">
                        To prevent malicious editing or deletion, you must create a **unique key of at least 12 characters**, using a mix of letters, numbers, and symbols. This key is the *only* way to edit your novel from any device. **Do not lose it!**
                    </p>
                </div>
                <div class="mb-6">
                    <label for="novel-edit-key" class="block text-sm font-medium text-text-light mb-1">**Secret Edit Key** (12+ characters recommended)</label>
                    <input type="password" id="novel-edit-key" required minlength="12"
                        class="w-full px-4 py-2 border border-red-600 rounded-lg bg-secondary-dark text-text-light focus:border-red-400 focus:ring focus:ring-red-400/50 transition"
                        placeholder="Create a long, safe key (e.g., SafeKey!42Alpha)">
                </div>
                <div class="mb-6">
                    <label for="novel-content-textarea" class="block text-sm font-medium text-text-light mb-1">Chapter 1 Content</label>
                    <textarea id="novel-content-textarea" required rows="10" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light novel-content-text focus:border-accent focus:ring focus:ring-accent/50 transition resize-y"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('add-novel-modal').classList.add('hidden')"
                        class="px-6 py-2 border border-slate-600 text-text-light rounded-lg hover:bg-slate-700 transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
                        Publish Novel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="view-novel-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-40 p-4">
        <div class="bg-primary-dark p-6 md:p-8 rounded-xl w-full max-w-5xl shadow-2xl h-[95vh] flex flex-col">
            
            <div class="flex justify-between items-start border-b border-accent/50 pb-4 mb-4">
                <div>
                    <h2 id="view-novel-title" class="text-3xl font-extrabold text-white"></h2>
                    <p class="text-md text-slate-400 mt-1">by <span id="view-novel-author" class="font-semibold text-accent"></span></p>
                    <p id="view-novel-id" class="text-xs text-slate-500 mt-2"></p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="promptForEditKey(activeNovel.id, 'edit')" title="Edit Novel"
                        class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.045 7.401c.365.365.365.912 0 1.278l-5.6 5.601-2.52 2.52-1.42 1.42-3.841 3.841c-.085.085-.17.17-.282.254-.112.084-.236.148-.36.195-.247.094-.509.141-.771.141-.26 0-.52-.046-.77-.138-.135-.049-.259-.114-.383-.199-.125-.084-.236-.179-.321-.295-.125-.165-.213-.357-.27-.565-.057-.208-.086-.427-.086-.645-.001-.218.028-.437.085-.645.057-.209.145-.401.27-.567.085-.116.196-.211.321-.295.125-.084.25-.15.385-.197.25-.09.51-.138.77-.138.262 0 .524.047.771.141.124.047.248.111.36.195.112.084.22.17.282.254l3.841-3.841 1.42-1.42 2.52-2.52 5.601-5.601c.365-.365.912-.365 1.278 0zm-11.233 13.567-4.11-4.11 7.221-7.222 4.11 4.11z"/>
                        </svg>
                    </button>

                    <button onclick="promptForEditKey(activeNovel.id, 'delete')" title="Delete Novel"
                        class="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 6h-2v-1c0-1.103-.897-2-2-2h-4c-1.103 0-2 .897-2 2v1H6v2h12v-2zM8 7V5h8v2H8zM8 9v10c0 1.103.897 2 2 2h4c1.103 0 2-.897 2-2V9H8z"/>
                        </svg>
                    </button>
                    <button onclick="document.getElementById('view-novel-modal').classList.add('hidden'); stopTtsPlayback();"
                        class="p-2 bg-secondary-dark text-text-light rounded-full hover:bg-slate-600 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="m16.192 6.344-4.192 4.192-4.192-4.192-1.416 1.416 4.192 4.192-4.192 4.192 1.416 1.416 4.192-4.192 4.192 4.192 1.416-1.416-4.192-4.192 4.192-4.192z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div class="lg:col-span-1 space-y-6">

                    <div class="bg-secondary-dark p-4 rounded-xl shadow-inner border border-slate-700">
                        <h3 class="text-xl font-semibold text-text-light mb-3 border-b border-slate-600 pb-2">Multilingual Tools</h3>
                        <p class="text-sm text-slate-400 mb-3">Use the Google Translate widget below to instantly translate the novel content.</p>
                        
                        <div id="google_translate_element" class="mt-4 p-2 bg-primary-dark rounded-lg border border-slate-600">
                            </div>
                    </div>

                    <div class="bg-secondary-dark p-4 rounded-xl shadow-inner border border-slate-700">
                        <h3 class="text-xl font-semibold text-text-light mb-3 border-b border-slate-600 pb-2">Text-to-Speech (Free)</h3>
                        <p class="text-sm text-slate-400 mb-3">Uses your browser's native text-to-speech engine with **Word Highlighting**.</p>
                        <div class="space-y-3">
                            <select id="tts-voice-select" class="w-full px-3 py-2 border border-slate-600 rounded-lg bg-primary-dark text-text-light">
                                </select>

                            <div>
                                <label for="tts-rate-slider" class="block text-sm font-medium text-text-light mb-1 flex justify-between">
                                    Speech Speed: <span id="tts-rate-value">1.0x</span>
                                </label>
                                <input type="range" id="tts-rate-slider" min="0.5" max="2.0" value="1.0" step="0.1" 
                                    class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-accent/50 transition" 
                                    oninput="updateTtsRateValue(this.value)">
                            </div>
                            
                            <button id="tts-play-button" onclick="toggleTtsPlayback(this)" 
                                class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-green-700 transition">
                                Play Audio 🔊
                            </button>
                        </div>
                    </div>

                </div>
                
                <div class="lg:col-span-2 flex flex-col">
                    <h3 id="translated-text-label" class="text-xl font-semibold text-text-light mb-4 border-b border-slate-700 pb-2">Novel Content (Word Tracing Active)</h3>
                    <div id="novel-display-content" class="flex-grow overflow-y-auto p-4 border border-slate-700 rounded-lg bg-primary-dark novel-content-text text-slate-200">
                        </div>
                </div>

            </div>
        </div>
    </div>
    
    <div id="edit-novel-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div class="bg-primary-dark p-6 md:p-8 rounded-xl w-full max-w-lg shadow-2xl transform transition-all duration-300">
            <h2 class="text-2xl font-bold text-text-light mb-6 border-b border-slate-700 pb-2">Edit Webnovel: <span id="edit-novel-title-display"></span></h2>
            <form id="edit-novel-form" onsubmit="handleNovelEdit(event)">
                <input type="hidden" id="edit-novel-id">
                <div class="mb-4">
                    <label for="edit-novel-title" class="block text-sm font-medium text-text-light mb-1">Title</label>
                    <input type="text" id="edit-novel-title" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-4">
                    <label for="edit-novel-author" class="block text-sm font-medium text-text-light mb-1">Author Name (Your Publisher ID)</label>
                    <input type="text" id="edit-novel-author" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition"
                        placeholder="e.g., TheSilentPen">
                </div>
                <div class="mb-4">
                    <label for="edit-novel-cover-image" class="block text-sm font-medium text-text-light mb-1">Cover Image URL (Optional)</label>
                    <input type="text" id="edit-novel-cover-image" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition"
                        placeholder="Paste a link to your novel's cover image">
                </div>
                <div class="mb-4">
                    <label for="edit-novel-tags" class="block text-sm font-medium text-text-light mb-1">Tags (e.g., Fantasy, Sci-Fi, Action - comma separated)</label>
                    <input type="text" id="edit-novel-tags" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-6">
                    <label for="edit-novel-content-textarea" class="block text-sm font-medium text-text-light mb-1">Chapter 1 Content</label>
                    <textarea id="edit-novel-content-textarea" required rows="10" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light novel-content-text focus:border-accent focus:ring focus:ring-accent/50 transition resize-y"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('edit-novel-modal').classList.add('hidden')"
                        class="px-6 py-2 border border-slate-600 text-text-light rounded-lg hover:bg-slate-700 transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        // Function required by Google Translate widget
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en', // Assuming English is the base language
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        // --- Globals ---
        let currentUserId = 'user-' + (localStorage.getItem('userId') || crypto.randomUUID()); 
        let currentNovels = [];
        let activeNovel = null; // Stores the currently viewed novel object
        let speechSynthesisUtterance = null;
        let speechSynth = window.speechSynthesis;
        let pendingAction = null; // For confirmation box
        let currentRate = 1.0; 
        let currentWordSpan = null; 

        // Constants
        const LOCAL_STORAGE_KEY = 'delightNovels';
        const VOICE_STORAGE_KEY = 'ttsVoiceName';
        const RATE_STORAGE_KEY = 'ttsRate'; 
        const DEFAULT_COVER_URL = "https://via.placeholder.com/300x400.png?text=Novel+Cover";


        /**
         * Initializes the application.
         */
        function initApp() {
            // Persist the unique user ID (to allow the user to keep tracking their own browser)
            localStorage.setItem('userId', currentUserId.split('-')[1]);
            console.log("App Initialized. Using local storage for data persistence. User ID is for browser tracking only, editing is key-based.");

            // Set the novel list title and load data
            document.getElementById('novel-list-title').textContent = "My Published Novels (Saved in this Browser)";
            loadAndRenderNovels();
            
            // Setup TTS voices and rate
            setupTtsVoices();
            setupTtsRateControl();
        }

        // --- Local Storage CRUD Operations ---

        /**
         * Loads all novels from local storage.
         * @returns {Array} List of novel objects.
         */
        function loadNovelsFromStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error loading novels from localStorage:", e);
                return [];
            }
        }

        /**
         * Saves the entire novel array back to local storage.
         * @param {Array} novels - The array of novel objects to save.
         */
        function saveNovelsToStorage(novels) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(novels));
            } catch (e) {
                console.error("Error saving novels to localStorage:", e);
                showMessageBox("Save Error", "Could not save novel data. Local storage might be full or blocked.", false);
            }
        }

        /**
         * Loads data from local storage and renders the novel cards.
         */
        function loadAndRenderNovels() {
            currentNovels = loadNovelsFromStorage();
            // Render the full list and clear the search bar if it had content
            document.getElementById('novel-search-input').value = "";
            renderNovels(currentNovels, false);
        }
        
        // --- Novel Search Function ---

        /**
         * Filters the novels based on a search query and renders the results.
         * @param {string} query - The search string from the input.
         */
        function filterAndRenderNovels(query) {
            const normalizedQuery = query.toLowerCase().trim();

            if (normalizedQuery === "") {
                // If the query is empty, show all novels
                renderNovels(currentNovels, false); 
                return;
            }

            // Filter the novels
            const filteredNovels = currentNovels.filter(novel => {
                // Fields to search: title, author, and tags
                const searchFields = [
                    novel.title.toLowerCase(),
                    novel.author.toLowerCase(),
                    Array.isArray(novel.tags) ? novel.tags.join(' ').toLowerCase() : ''
                ];

                // Check if the query is included in any of the search fields
                return searchFields.some(field => field.includes(normalizedQuery));
            });

            // Render the filtered list and tell renderNovels that this is a search result
            renderNovels(filteredNovels, true);
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the novel cards based on the fetched data.
         * @param {Array} novels - The list of novels to display.
         * @param {boolean} isFiltered - True if the list is a result of a search filter.
         */
        function renderNovels(novels, isFiltered = false) {
            const container = document.getElementById('novel-list-container');
            container.innerHTML = ''; // Clear existing content

            if (novels.length === 0) {
                const message = isFiltered 
                    ? `No webnovels found matching your search term.` 
                    : `No novels published yet.`;
                const subtitle = isFiltered 
                    ? `Try a different keyword or clear the search to see all novels.`
                    : `Click '+ Publish New Novel' to create your first webnovel!`;
                
                // Set to span all columns for the center message
                container.className = 'grid grid-cols-1';
                container.innerHTML = `
                    <div class="text-center p-10 bg-secondary-dark rounded-xl border border-slate-700 max-w-2xl mx-auto w-full mt-6">
                        <p class="text-xl text-slate-400">${message}</p>
                        <p class="text-sm text-slate-500 mt-2">${subtitle}</p>
                    </div>
                `;
                return;
            }

            // Reset grid layout for novels (4-column grid on large screens)
            container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';

            novels.forEach(novel => {
                // Ensure tags is a safe array
                const tags = Array.isArray(novel.tags) ? novel.tags : (novel.tags || "").split(',').map(t => t.trim()).filter(t => t);
                
                const coverUrl = novel.coverImageUrl && novel.coverImageUrl.trim() ? novel.coverImageUrl.trim() : DEFAULT_COVER_URL;
                const isPlaceholder = coverUrl === DEFAULT_COVER_URL;

                const card = document.createElement('div');
                card.className = 'bg-primary-dark rounded-xl shadow-lg border border-slate-700 hover:border-accent transition duration-200 cursor-pointer flex flex-col overflow-hidden';
                card.onclick = () => openNovelModal(novel.id);
                
                card.innerHTML = `
                    <div class="w-full h-64 overflow-hidden ${isPlaceholder ? 'novel-cover-placeholder' : ''}">
                        ${isPlaceholder 
                            ? `<span class="p-4 text-center">No Cover Image<br/>(Click to View)</span>` 
                            : `<img src="${coverUrl}" alt="${novel.title} Cover" class="w-full h-full object-cover">`
                        }
                    </div>

                    <div class="p-4 flex flex-col justify-between flex-grow">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1 line-clamp-2">${novel.title}</h3>
                            <p class="text-sm text-slate-400 mb-3">by <span class="font-semibold text-accent">${novel.author}</span></p>
                            <div class="flex flex-wrap gap-1 mb-3">
                                ${tags.slice(0, 3).map(tag => `<span class="text-xs bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                                ${tags.length > 3 ? `<span class="text-xs text-slate-500 px-2 py-0.5">...</span>` : ''}
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                            <p class="text-xs text-slate-500">Published: ${new Date(novel.createdAt).toLocaleDateString()}</p>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); promptForEditKey('${novel.id}', 'edit')" 
                                    class="text-blue-400 hover:text-blue-500 transition text-sm font-medium p-1 rounded-md">
                                    Edit
                                </button>
                                <button onclick="event.stopPropagation(); promptForEditKey('${novel.id}', 'delete')" 
                                    class="text-red-400 hover:text-red-500 transition text-sm font-medium p-1 rounded-md">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Utility Functions for Novel Content ---

        /**
         * Takes raw text and wraps each word in a span for TTS highlighting.
         * @param {string} text - The raw novel content.
         * @returns {string} HTML string with words wrapped in spans.
         */
        function prepareContentForTtsHighlight(text) {
            // Split by space, newline, and common punctuation marks, keeping the delimiters.
            const parts = text.split(/(\s+|[.,!?;:(){}[\]"'-—\u2013\u2014]|\n)/g).filter(p => p.length > 0);
            
            return parts.map(part => {
                // Check if the part is a 'word' (contains letters or numbers)
                if (/[a-zA-Z0-9]/.test(part)) {
                    // Span for highlighting
                    return `<span class="word">${part}</span>`;
                }
                // Return whitespace, punctuation, etc. as-is (but escape HTML if necessary)
                return part.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }).join('');
        }

        // --- Key-Based Authentication Logic ---

        /**
         * Prompts the user for the secret edit key before performing a protected action.
         * @param {string} novelId - The ID of the novel.
         * @param {string} actionType - 'edit' or 'delete'.
         */
        function promptForEditKey(novelId, actionType) {
            const novel = currentNovels.find(n => n.id === novelId);
            if (!novel) {
                showMessageBox("Error", "Novel not found.", false);
                return;
            }

            // Using standard browser prompt for simplicity and cross-device functionality
            const keyAttempt = prompt(`Enter the SECRET EDIT KEY for "${novel.title}" to ${actionType}:`);

            if (keyAttempt === null) {
                // User pressed Cancel
                return;
            }

            if (keyAttempt.trim() === novel.editKey) {
                if (actionType === 'edit') {
                    editNovel(novelId);
                } else if (actionType === 'delete') {
                    deleteNovel(novelId);
                }
            } else {
                showMessageBox("Authentication Failed", "The secret key you entered is incorrect. Access denied.", false);
            }
        }
        
        // --- Event Handlers & Modal Logic ---

        /**
         * Handles the form submission for publishing a new novel.
         */
        function handleNovelSubmit(event) {
            event.preventDefault();

            const title = document.getElementById('novel-title').value.trim();
            const author = document.getElementById('novel-author').value.trim();
            const coverImageUrl = document.getElementById('novel-cover-image').value.trim();
            const tagsInput = document.getElementById('novel-tags').value.trim();
            const editKey = document.getElementById('novel-edit-key').value.trim();
            const content = document.getElementById('novel-content-textarea').value.trim();

            if (!title || !author || !content || !editKey) {
                showMessageBox("Validation Error", "Please fill in the title, author, key, and chapter content.", false);
                return;
            }

            if (editKey.length < 12) {
                 showMessageBox("Security Warning", "The Secret Edit Key must be at least 12 characters long for your novel's safety.", false);
                return;
            }

            const newNovel = {
                id: crypto.randomUUID(),
                title: title,
                author: author,
                coverImageUrl: coverImageUrl, 
                editKey: editKey, 
                tags: tagsInput.split(',').map(t => t.trim()).filter(t => t),
                content: content,
                createdAt: new Date().toISOString(),
                userId: currentUserId 
            };
            
            // Add to the local array and save
            currentNovels.unshift(newNovel);
            saveNovelsToStorage(currentNovels);

            // Close modal and refresh UI
            document.getElementById('add-novel-modal').classList.add('hidden');
            document.getElementById('add-novel-form').reset();
            loadAndRenderNovels(); 
            showMessageBox("Success!", "Your novel has been published successfully. **REMEMBER YOUR SECRET KEY!**", false);
        }

        /**
         * Opens the modal to view a novel's content.
         * @param {string} novelId - The ID of the novel to view.
         */
        function openNovelModal(novelId) {
            stopTtsPlayback(); // Stop any currently playing audio
            removeHighlight(); // Clear any lingering highlight

            activeNovel = currentNovels.find(n => n.id === novelId);
            if (!activeNovel) {
                showMessageBox("Error", "Novel not found.", false);
                return;
            }

            document.getElementById('view-novel-title').textContent = activeNovel.title;
            document.getElementById('view-novel-author').textContent = activeNovel.author;
            document.getElementById('view-novel-id').textContent = `ID: ${activeNovel.id.substring(0, 8)}...`;
            
            // Prepare content for highlighting
            document.getElementById('novel-display-content').innerHTML = prepareContentForTtsHighlight(activeNovel.content);
            
            document.getElementById('view-novel-modal').classList.remove('hidden');
        }

        /**
         * Opens the modal to edit a novel (after key validation).
         * @param {string} novelId - The ID of the novel to edit.
         */
        function editNovel(novelId) {
            stopTtsPlayback();
            document.getElementById('view-novel-modal').classList.add('hidden'); // Close view modal

            const novelToEdit = currentNovels.find(n => n.id === novelId);

            if (!novelToEdit) {
                showMessageBox("Error", "Novel not found for editing.", false);
                return;
            }

            // Populate Edit Modal
            document.getElementById('edit-novel-id').value = novelToEdit.id;
            document.getElementById('edit-novel-title').value = novelToEdit.title;
            document.getElementById('edit-novel-author').value = novelToEdit.author;
            document.getElementById('edit-novel-cover-image').value = novelToEdit.coverImageUrl || ''; 
            document.getElementById('edit-novel-tags').value = Array.isArray(novelToEdit.tags) ? novelToEdit.tags.join(', ') : novelToEdit.tags || '';
            document.getElementById('edit-novel-content-textarea').value = novelToEdit.content;
            document.getElementById('edit-novel-title-display').textContent = novelToEdit.title;

            document.getElementById('edit-novel-modal').classList.remove('hidden');
        }

        /**
         * Handles the form submission for editing an existing novel.
         */
        function handleNovelEdit(event) {
            event.preventDefault();

            const id = document.getElementById('edit-novel-id').value;
            const title = document.getElementById('edit-novel-title').value.trim();
            const author = document.getElementById('edit-novel-author').value.trim();
            const coverImageUrl = document.getElementById('edit-novel-cover-image').value.trim(); 
            const tagsInput = document.getElementById('edit-novel-tags').value.trim();
            const content = document.getElementById('edit-novel-content-textarea').value.trim();

            if (!title || !author || !content) {
                showMessageBox("Validation Error", "Please fill in the title, author, and chapter content.", false);
                return;
            }

            const index = currentNovels.findIndex(n => n.id === id);

            if (index > -1) {
                // Update the novel object
                currentNovels[index] = {
                    ...currentNovels[index],
                    title: title,
                    author: author,
                    coverImageUrl: coverImageUrl, 
                    tags: tagsInput.split(',').map(t => t.trim()).filter(t => t),
                    content: content,
                    updatedAt: new Date().toISOString()
                };

                saveNovelsToStorage(currentNovels);

                // Close modal and refresh UI
                document.getElementById('edit-novel-modal').classList.add('hidden');
                loadAndRenderNovels(); 
                showMessageBox("Success!", "Your novel has been updated successfully.", false);
            } else {
                 showMessageBox("Error", "Novel ID not found for update.", false);
            }
        }


        /**
         * Prepares for deletion (after key validation).
         * @param {string} novelId - The ID of the novel to delete.
         */
        function deleteNovel(novelId) {
            stopTtsPlayback();

            const idToDelete = novelId;
            if (!idToDelete) {
                showMessageBox("Error", "No novel selected for deletion.", false);
                return;
            }

            // Set up confirmation
            pendingAction = () => {
                const index = currentNovels.findIndex(n => n.id === idToDelete);
                if (index > -1) {
                    currentNovels.splice(index, 1);
                    saveNovelsToStorage(currentNovels);
                    loadAndRenderNovels(); 
                    
                    // Close view modal if the deleted novel was being viewed
                    if (activeNovel && activeNovel.id === idToDelete) {
                        document.getElementById('view-novel-modal').classList.add('hidden');
                        activeNovel = null;
                    }
                    showMessageBox("Deleted", "Novel removed successfully.", false);
                } else {
                    showMessageBox("Error", "Novel not found in database.", false);
                }
                pendingAction = null;
            };

            showMessageBox(
                "Confirm Deletion",
                "Are you sure you want to permanently delete this novel? This action cannot be undone.",
                true
            );
        }
        
        // --- Custom Message Box (Replaces alert/confirm) ---

        let resolveMessageBox = null;

        function showMessageBox(title, content, showCancel) {
            return new Promise(resolve => {
                resolveMessageBox = resolve;
                document.getElementById('message-box-title').textContent = title;
                document.getElementById('message-box-content').textContent = content;

                const cancelBtn = document.getElementById('message-box-cancel');
                if (showCancel) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }
                
                document.getElementById('message-box').classList.remove('hidden');
            });
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            if (resolveMessageBox) {
                resolveMessageBox(false);
                resolveMessageBox = null;
                pendingAction = null;
            }
        }

        function confirmMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            if (pendingAction) {
                pendingAction();
            }
            if (resolveMessageBox) {
                resolveMessageBox(true);
                resolveMessageBox = null;
            }
        }

        // --- Text-to-Speech (TTS) Logic ---

        /**
         * Initializes the TTS rate control slider with the last saved value.
         */
        function setupTtsRateControl() {
            const storedRate = localStorage.getItem(RATE_STORAGE_KEY);
            if (storedRate) {
                currentRate = parseFloat(storedRate);
            }
            document.getElementById('tts-rate-slider').value = currentRate;
            document.getElementById('tts-rate-value').textContent = `${currentRate.toFixed(1)}x`;
        }

        /**
         * Updates the display value and saves the TTS rate.
         * @param {string} rateValue - The new rate value from the slider.
         */
        function updateTtsRateValue(rateValue) {
            currentRate = parseFloat(rateValue);
            localStorage.setItem(RATE_STORAGE_KEY, currentRate.toString());
            document.getElementById('tts-rate-value').textContent = `${currentRate.toFixed(1)}x`;
            
            // If speaking, cancel and restart with the new rate for immediate effect
            if (speechSynth.speaking) {
                // Toggle stops and then starts in the next line
                stopTtsPlayback(); 
                toggleTtsPlayback(document.getElementById('tts-play-button'));
            }
        }


        /**
         * Populates the TTS voice selector dropdown.
         */
        function setupTtsVoices() {
            // Wait for voices to be loaded
            if(speechSynth.getVoices().length === 0) {
                speechSynth.onvoiceschanged = populateVoiceList;
            } else {
                populateVoiceList();
            }
        }
        
        /**
         * Fills the dropdown with available voices and selects the last used one.
         */
        function populateVoiceList() {
            const selectElement = document.getElementById('tts-voice-select');
            const storedVoiceName = localStorage.getItem(VOICE_STORAGE_KEY);
            selectElement.innerHTML = '';

            const voices = speechSynth.getVoices();
            if (voices.length === 0) {
                selectElement.innerHTML = '<option>No voices found.</option>';
                return;
            }
            
            let selectedIndex = 0;
            
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                
                if (storedVoiceName && voice.name === storedVoiceName) {
                    selectedIndex = index;
                }

                selectElement.appendChild(option);
            });
            
            selectElement.selectedIndex = selectedIndex;
        }

        /**
         * Removes the highlighting from all words.
         */
        function removeHighlight() {
            const contentContainer = document.getElementById('novel-display-content');
            // Remove the highlight class from all spans
            contentContainer.querySelectorAll('.highlight-word').forEach(span => {
                span.classList.remove('highlight-word');
            });
            currentWordSpan = null;
        }

        /**
         * Starts or stops the native TTS playback.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        function toggleTtsPlayback(button) {
            if (!activeNovel) return;

            if (speechSynth.speaking) {
                stopTtsPlayback();
                return;
            }
            
            // Remove any old highlights before starting a new one
            removeHighlight(); 
            
            // Get content and selected voice
            const content = activeNovel.content; // Use the raw content for the TTS engine
            const voiceName = document.getElementById('tts-voice-select').value;
            const voice = speechSynth.getVoices().find(v => v.name === voiceName);

            if (!voice) {
                showMessageBox("TTS Error", "Selected voice is not available. Please try another.", false);
                return;
            }

            // Save selected voice preference
            localStorage.setItem(VOICE_STORAGE_KEY, voiceName);

            // Setup speech utterance
            speechSynthesisUtterance = new SpeechSynthesisUtterance(content);
            speechSynthesisUtterance.voice = voice;
            speechSynthesisUtterance.rate = currentRate; // Apply the selected rate
            speechSynthesisUtterance.pitch = 1.0;
            
            const words = document.getElementById('novel-display-content').querySelectorAll('.word');
            let wordIndex = 0;

            speechSynthesisUtterance.onstart = () => {
                button.textContent = 'Stop Audio 🛑';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            };

            // Highlight the word being spoken and scroll it into view
            speechSynthesisUtterance.onboundary = (event) => {
                // event.name is 'word' for a word boundary
                if (event.name === 'word') {
                    // Check if the current word index is within the bounds of the rendered words
                    if (wordIndex < words.length) {
                        // 1. Remove previous highlight
                        if (currentWordSpan) {
                            currentWordSpan.classList.remove('highlight-word');
                        }

                        // 2. Apply new highlight (This is the I-beam/carrot movement)
                        currentWordSpan = words[wordIndex];
                        currentWordSpan.classList.add('highlight-word');
                        
                        // 3. Scroll to the highlighted word for better UX (Auto-scrolling)
                        currentWordSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        wordIndex++;
                    }
                }
            };

            speechSynthesisUtterance.onend = () => {
                stopTtsPlayback();
            };
            
            speechSynthesisUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                stopTtsPlayback();
                showMessageBox("TTS Error", `Could not play audio: ${event.error}`, false);
            };

            speechSynth.speak(speechSynthesisUtterance);
        }

        /**
         * Stops the native TTS playback and resets the button and highlights.
         */
        function stopTtsPlayback() {
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }
            removeHighlight(); // Clear highlight when stopped
            const button = document.getElementById('tts-play-button');
            if (button) {
                button.textContent = 'Play Audio 🔊';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Initialize the application on page load
        window.onload = initApp;
    </script>
</body>
</html>
