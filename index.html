<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelightNovel - Free Webnovel Reader & Publisher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Configuration for Dark Mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Using a pitch black background for the body
                        'body-dark': '#000000',
                        'primary-dark': '#1e293b',   // Slate-800
                        'secondary-dark': '#334155', // Slate-700
                        'text-light': '#f8fafc',     // Slate-50
                        'text-dark': '#0f172a',      // Slate-900
                        'accent': '#6366f1',         // Indigo-500
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pitch Black Background */
            color: #f8fafc;
            min-height: 100vh;
        }

        /* Custom scrollbar for novel content */
        #novel-display-content::-webkit-scrollbar,
        #novel-content-textarea::-webkit-scrollbar {
            width: 8px;
            background-color: #1e293b;
            border-radius: 4px;
        }

        #novel-display-content::-webkit-scrollbar-thumb,
        #novel-content-textarea::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 4px;
        }

        .novel-content-text {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-body-dark text-text-light p-4 md:p-8">

    <!-- Main Title and Navigation -->
    <header class="mb-8 border-b border-indigo-500/50 pb-4">
        <h1 class="text-4xl font-extrabold text-white text-center">
            DelightNovel <span class="text-accent text-lg font-light">Free Publishing & Reader</span>
        </h1>
    </header>

    <main class="max-w-6xl mx-auto">
        
        <!-- Action Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <h2 id="novel-list-title" class="text-2xl font-semibold text-text-light"></h2>
            
            <div class="flex space-x-3 w-full sm:w-auto">
                <!-- Add New Novel Button -->
                <button onclick="document.getElementById('add-novel-modal').classList.remove('hidden')"
                    class="flex-grow sm:flex-grow-0 bg-accent text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-600 transition duration-200">
                    + Publish New Novel
                </button>
            </div>
        </div>

        <!-- Novel List Container -->
        <div id="novel-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Novel Cards will be inserted here -->
        </div>

        <!-- Notification/Message Box (for modal-style confirmation/alert) -->
        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-primary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border border-accent/50 transform transition-all duration-300 scale-100">
                <h3 id="message-box-title" class="text-xl font-bold text-accent mb-3"></h3>
                <p id="message-box-content" class="text-text-light mb-5"></p>
                <div class="flex justify-end space-x-3">
                    <button id="message-box-cancel" onclick="closeMessageBox()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition hidden">Cancel</button>
                    <button id="message-box-confirm" onclick="confirmMessageBox()" class="px-4 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-indigo-600 transition">OK</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal for Adding/Publishing a New Novel -->
    <div id="add-novel-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div class="bg-primary-dark p-6 md:p-8 rounded-xl w-full max-w-lg shadow-2xl transform transition-all duration-300">
            <h2 class="text-2xl font-bold text-text-light mb-6 border-b border-slate-700 pb-2">Publish New Webnovel</h2>
            <form id="add-novel-form" onsubmit="handleNovelSubmit(event)">
                <div class="mb-4">
                    <label for="novel-title" class="block text-sm font-medium text-text-light mb-1">Title</label>
                    <input type="text" id="novel-title" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-4">
                    <label for="novel-author" class="block text-sm font-medium text-text-light mb-1">Author Name</label>
                    <input type="text" id="novel-author" required 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-4">
                    <label for="novel-tags" class="block text-sm font-medium text-text-light mb-1">Tags (e.g., Fantasy, Sci-Fi, Action - comma separated)</label>
                    <input type="text" id="novel-tags" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light focus:border-accent focus:ring focus:ring-accent/50 transition">
                </div>
                <div class="mb-6">
                    <label for="novel-content-textarea" class="block text-sm font-medium text-text-light mb-1">Chapter 1 Content</label>
                    <textarea id="novel-content-textarea" required rows="10" 
                        class="w-full px-4 py-2 border border-slate-600 rounded-lg bg-secondary-dark text-text-light novel-content-text focus:border-accent focus:ring focus:ring-accent/50 transition resize-y"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('add-novel-modal').classList.add('hidden')"
                        class="px-6 py-2 border border-slate-600 text-text-light rounded-lg hover:bg-slate-700 transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
                        Publish Novel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Viewing Novel Details and Reading -->
    <div id="view-novel-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-40 p-4">
        <div class="bg-primary-dark p-6 md:p-8 rounded-xl w-full max-w-5xl shadow-2xl h-[95vh] flex flex-col">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-start border-b border-accent/50 pb-4 mb-4">
                <div>
                    <h2 id="view-novel-title" class="text-3xl font-extrabold text-white"></h2>
                    <p class="text-md text-slate-400 mt-1">by <span id="view-novel-author" class="font-semibold text-accent"></span></p>
                    <p id="view-novel-id" class="text-xs text-slate-500 mt-2"></p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="deleteNovel()" title="Delete Novel"
                        class="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 6h-2v-1c0-1.103-.897-2-2-2h-4c-1.103 0-2 .897-2 2v1H6v2h12v-2zM8 7V5h8v2H8zM8 9v10c0 1.103.897 2 2 2h4c1.103 0 2-.897 2-2V9H8z"/>
                        </svg>
                    </button>
                    <button onclick="document.getElementById('view-novel-modal').classList.add('hidden')"
                        class="p-2 bg-secondary-dark text-text-light rounded-full hover:bg-slate-600 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="m16.192 6.344-4.192 4.192-4.192-4.192-1.416 1.416 4.192 4.192-4.192 4.192 1.416 1.416 4.192-4.192 4.192 4.192 1.416-1.416-4.192-4.192 4.192-4.192z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Reading Panel -->
            <div class="flex-grow overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Control Panel (Left/Top) -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- Translation Section -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-inner border border-slate-700">
                        <h3 class="text-xl font-semibold text-text-light mb-3 border-b border-slate-600 pb-2">Multilingual Tools</h3>
                        <p class="text-sm text-slate-400 mb-3">Use the Google Translate widget below to instantly translate the novel content.</p>
                        
                        <!-- Google Translate Widget Placeholder (Manual implementation is required, but we show the required script) -->
                        <div id="google_translate_element" class="mt-4 p-2 bg-primary-dark rounded-lg border border-slate-600">
                            <!-- This will be populated by the Google Translate script -->
                        </div>
                    </div>

                    <!-- TTS Section (Free, Browser Native) -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-inner border border-slate-700">
                        <h3 class="text-xl font-semibold text-text-light mb-3 border-b border-slate-600 pb-2">Text-to-Speech (Free)</h3>
                        <p class="text-sm text-slate-400 mb-3">Uses your browser's native text-to-speech engine. Audio volume controlled by device/browser.</p>
                        <div class="space-y-3">
                            <!-- Voice Selector -->
                            <select id="tts-voice-select" class="w-full px-3 py-2 border border-slate-600 rounded-lg bg-primary-dark text-text-light">
                                <!-- Options populated by JS -->
                            </select>
                            
                            <!-- Play Button -->
                            <button id="tts-play-button" onclick="toggleTtsPlayback(this)" 
                                class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-green-700 transition">
                                Play Audio 🔊
                            </button>
                        </div>
                    </div>

                </div>
                
                <!-- Content Display (Right/Bottom) -->
                <div class="lg:col-span-2 flex flex-col">
                    <h3 id="translated-text-label" class="text-xl font-semibold text-text-light mb-4 border-b border-slate-700 pb-2">Novel Content</h3>
                    <div id="novel-display-content" class="flex-grow overflow-y-auto p-4 border border-slate-700 rounded-lg bg-primary-dark novel-content-text text-slate-200">
                        <!-- Novel content goes here -->
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Google Translate Script (Must be outside type="module" script block) -->
    <script type="text/javascript">
        // Function required by Google Translate widget
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en', // Assuming English is the base language
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <!-- Application Logic -->
    <script>
        // --- Globals ---
        let currentUserId = 'user-' + (localStorage.getItem('userId') || crypto.randomUUID());
        let currentNovels = [];
        let activeNovel = null; // Stores the currently viewed novel object
        let speechSynthesisUtterance = null;
        let speechSynth = window.speechSynthesis;
        let pendingAction = null; // For confirmation box

        // Constants
        const LOCAL_STORAGE_KEY = 'delightNovels';
        const VOICE_STORAGE_KEY = 'ttsVoiceName';

        /**
         * Initializes the application.
         * Switches from external database to local storage.
         */
        function initApp() {
            // Set the unique user ID (persisted across sessions)
            localStorage.setItem('userId', currentUserId.split('-')[1]);
            console.log("App Initialized. Using local storage for data persistence.");
            console.log("Local User ID (for debugging):", currentUserId);

            // Set the novel list title and load data
            document.getElementById('novel-list-title').textContent = "My Published Novels";
            loadAndRenderNovels();
            
            // Setup TTS voices
            setupTtsVoices();
        }

        // --- Local Storage CRUD Operations ---

        /**
         * Loads all novels from local storage.
         * @returns {Array} List of novel objects.
         */
        function loadNovelsFromStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error loading novels from localStorage:", e);
                return [];
            }
        }

        /**
         * Saves the entire novel array back to local storage.
         * @param {Array} novels - The array of novel objects to save.
         */
        function saveNovelsToStorage(novels) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(novels));
            } catch (e) {
                console.error("Error saving novels to localStorage:", e);
                showMessageBox("Save Error", "Could not save novel data. Local storage might be full or blocked.", false);
            }
        }

        /**
         * Loads data from local storage and renders the novel cards.
         * This replaces the Firestore onSnapshot listener.
         */
        function loadAndRenderNovels() {
            currentNovels = loadNovelsFromStorage();
            renderNovels(currentNovels);
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the novel cards based on the fetched data.
         * @param {Array} novels - The list of novels to display.
         */
        function renderNovels(novels) {
            const container = document.getElementById('novel-list-container');
            container.innerHTML = ''; // Clear existing content

            if (novels.length === 0) {
                container.innerHTML = `
                    <div class="lg:col-span-3 text-center p-10 bg-secondary-dark rounded-xl border border-slate-700">
                        <p class="text-xl text-slate-400">No novels published yet.</p>
                        <p class="text-sm text-slate-500 mt-2">Click '+ Publish New Novel' to create your first webnovel!</p>
                    </div>
                `;
                return;
            }

            novels.forEach(novel => {
                // Ensure tags is a safe array
                const tags = Array.isArray(novel.tags) ? novel.tags : (novel.tags || "").split(',').map(t => t.trim()).filter(t => t);
                
                const card = document.createElement('div');
                card.className = 'bg-primary-dark p-6 rounded-xl shadow-lg border border-slate-700 hover:border-accent transition duration-200 cursor-pointer flex flex-col justify-between';
                card.onclick = () => openNovelModal(novel.id);
                
                card.innerHTML = `
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-2 line-clamp-2">${novel.title}</h3>
                        <p class="text-sm text-slate-400 mb-4">by <span class="font-semibold text-accent">${novel.author}</span></p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${tags.map(tag => `<span class="text-xs bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                        <p class="text-xs text-slate-500">Novel ID: ${novel.id.substring(0, 8)}...</p>
                        <button onclick="event.stopPropagation(); deleteNovel('${novel.id}')" 
                            class="text-red-400 hover:text-red-500 transition text-sm font-medium p-1 rounded-md">
                            Delete
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Event Handlers & Modal Logic ---

        /**
         * Handles the form submission for publishing a new novel.
         */
        function handleNovelSubmit(event) {
            event.preventDefault();

            const title = document.getElementById('novel-title').value.trim();
            const author = document.getElementById('novel-author').value.trim();
            const tagsInput = document.getElementById('novel-tags').value.trim();
            const content = document.getElementById('novel-content-textarea').value.trim();

            if (!title || !author || !content) {
                showMessageBox("Validation Error", "Please fill in the title, author, and chapter content.", false);
                return;
            }

            const newNovel = {
                id: crypto.randomUUID(),
                title: title,
                author: author,
                tags: tagsInput.split(',').map(t => t.trim()).filter(t => t),
                content: content,
                createdAt: new Date().toISOString(),
                userId: currentUserId 
            };
            
            // Add to the local array and save
            currentNovels.unshift(newNovel);
            saveNovelsToStorage(currentNovels);

            // Close modal and refresh UI
            document.getElementById('add-novel-modal').classList.add('hidden');
            document.getElementById('add-novel-form').reset();
            loadAndRenderNovels();
            showMessageBox("Success!", "Your novel has been published successfully.", false);
        }

        /**
         * Opens the modal to view a novel's content.
         * @param {string} novelId - The ID of the novel to view.
         */
        function openNovelModal(novelId) {
            stopTtsPlayback(); // Stop any currently playing audio

            activeNovel = currentNovels.find(n => n.id === novelId);
            if (!activeNovel) {
                showMessageBox("Error", "Novel not found.", false);
                return;
            }

            document.getElementById('view-novel-title').textContent = activeNovel.title;
            document.getElementById('view-novel-author').textContent = activeNovel.author;
            document.getElementById('view-novel-id').textContent = `ID: ${activeNovel.id}`;
            document.getElementById('novel-display-content').textContent = activeNovel.content;
            
            document.getElementById('view-novel-modal').classList.remove('hidden');
        }

        /**
         * Deletes the currently active novel after confirmation.
         * @param {string} [novelId] - The ID of the novel to delete (optional, defaults to active novel).
         */
        function deleteNovel(novelId = null) {
            stopTtsPlayback();

            const idToDelete = novelId || (activeNovel ? activeNovel.id : null);
            if (!idToDelete) {
                showMessageBox("Error", "No novel selected for deletion.", false);
                return;
            }

            // Set up confirmation
            pendingAction = () => {
                const index = currentNovels.findIndex(n => n.id === idToDelete);
                if (index > -1) {
                    currentNovels.splice(index, 1);
                    saveNovelsToStorage(currentNovels);
                    loadAndRenderNovels();
                    
                    // Close view modal if the deleted novel was being viewed
                    if (activeNovel && activeNovel.id === idToDelete) {
                        document.getElementById('view-novel-modal').classList.add('hidden');
                        activeNovel = null;
                    }
                    showMessageBox("Deleted", "Novel removed successfully.", false);
                } else {
                    showMessageBox("Error", "Novel not found in database.", false);
                }
                pendingAction = null;
            };

            showMessageBox(
                "Confirm Deletion",
                "Are you sure you want to permanently delete this novel? This action cannot be undone.",
                true
            );
        }
        
        // --- Custom Message Box (Replaces alert/confirm) ---

        let resolveMessageBox = null;

        function showMessageBox(title, content, showCancel) {
            return new Promise(resolve => {
                resolveMessageBox = resolve;
                document.getElementById('message-box-title').textContent = title;
                document.getElementById('message-box-content').textContent = content;

                const cancelBtn = document.getElementById('message-box-cancel');
                if (showCancel) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }
                
                document.getElementById('message-box').classList.remove('hidden');
            });
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            if (resolveMessageBox) {
                resolveMessageBox(false);
                resolveMessageBox = null;
                pendingAction = null;
            }
        }

        function confirmMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            if (pendingAction) {
                pendingAction();
            }
            if (resolveMessageBox) {
                resolveMessageBox(true);
                resolveMessageBox = null;
            }
        }

        // --- Text-to-Speech (TTS) Logic (Free, Browser Native) ---

        /**
         * Populates the TTS voice selector dropdown.
         */
        function setupTtsVoices() {
            // Wait for voices to be loaded
            if(speechSynth.getVoices().length === 0) {
                speechSynth.onvoiceschanged = populateVoiceList;
            } else {
                populateVoiceList();
            }
        }
        
        /**
         * Fills the dropdown with available voices and selects the last used one.
         */
        function populateVoiceList() {
            const selectElement = document.getElementById('tts-voice-select');
            const storedVoiceName = localStorage.getItem(VOICE_STORAGE_KEY);
            selectElement.innerHTML = '';

            const voices = speechSynth.getVoices();
            if (voices.length === 0) {
                selectElement.innerHTML = '<option>No voices found.</option>';
                return;
            }
            
            let selectedIndex = 0;
            
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                
                if (storedVoiceName && voice.name === storedVoiceName) {
                    selectedIndex = index;
                }

                selectElement.appendChild(option);
            });
            
            selectElement.selectedIndex = selectedIndex;
        }

        /**
         * Starts or stops the native TTS playback.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        function toggleTtsPlayback(button) {
            if (!activeNovel) return;

            if (speechSynth.speaking) {
                stopTtsPlayback();
                return;
            }

            // Get content and selected voice
            const content = document.getElementById('novel-display-content').textContent;
            const voiceName = document.getElementById('tts-voice-select').value;
            const voice = speechSynth.getVoices().find(v => v.name === voiceName);

            if (!voice) {
                showMessageBox("TTS Error", "Selected voice is not available. Please try another.", false);
                return;
            }

            // Save selected voice preference
            localStorage.setItem(VOICE_STORAGE_KEY, voiceName);

            // Setup speech utterance
            speechSynthesisUtterance = new SpeechSynthesisUtterance(content);
            speechSynthesisUtterance.voice = voice;
            speechSynthesisUtterance.rate = 1.0;
            speechSynthesisUtterance.pitch = 1.0;
            
            speechSynthesisUtterance.onstart = () => {
                button.textContent = 'Stop Audio 🛑';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            };

            speechSynthesisUtterance.onend = () => {
                stopTtsPlayback();
            };

            speechSynth.speak(speechSynthesisUtterance);
        }

        /**
         * Stops the native TTS playback and resets the button.
         */
        function stopTtsPlayback() {
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }
            const button = document.getElementById('tts-play-button');
            if (button) {
                button.textContent = 'Play Audio 🔊';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        // Initialize the application on page load
        window.onload = initApp;

    </script>
</body>
</html>
